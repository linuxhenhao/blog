<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.84.1 with theme Tranquilpeak 0.4.8-BETA"><meta name=author content="Yu Huang"><meta name=keywords content="slow,graphic driver,systemd-analyze"><meta name=description content="问题描述：Y460 i3core m核显+ AMD HD5650，使用较老的硬件切换方式切换显卡。
新装Debian testing，内核版本4.16，分别为i915和radeon驱动两张显卡。在启动
后，显示出display manager的登陆界面正确输入用户名和密码后需要几十妙时间
等待图形界面出现。"><meta property="og:description" content="问题描述：Y460 i3core m核显+ AMD HD5650，使用较老的硬件切换方式切换显卡。
新装Debian testing，内核版本4.16，分别为i915和radeon驱动两张显卡。在启动
后，显示出display manager的登陆界面正确输入用户名和密码后需要几十妙时间
等待图形界面出现。"><meta property="og:type" content="article"><meta property="og:title" content="笔记本图形界面启动慢问题探索与解决"><meta name=twitter:title content="笔记本图形界面启动慢问题探索与解决"><meta property="og:url" content="https://blog.huangyu.me/2018/05/%E7%AC%94%E8%AE%B0%E6%9C%AC%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E5%90%AF%E5%8A%A8%E6%85%A2%E9%97%AE%E9%A2%98%E6%8E%A2%E7%B4%A2%E4%B8%8E%E8%A7%A3%E5%86%B3/"><meta property="twitter:url" content="https://blog.huangyu.me/2018/05/%E7%AC%94%E8%AE%B0%E6%9C%AC%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E5%90%AF%E5%8A%A8%E6%85%A2%E9%97%AE%E9%A2%98%E6%8E%A2%E7%B4%A2%E4%B8%8E%E8%A7%A3%E5%86%B3/"><meta property="og:site_name" content="多学多思考"><meta property="og:description" content="问题描述：Y460 i3core m核显+ AMD HD5650，使用较老的硬件切换方式切换显卡。
新装Debian testing，内核版本4.16，分别为i915和radeon驱动两张显卡。在启动
后，显示出display manager的登陆界面正确输入用户名和密码后需要几十妙时间
等待图形界面出现。"><meta name=twitter:description content="问题描述：Y460 i3core m核显+ AMD HD5650，使用较老的硬件切换方式切换显卡。
新装Debian testing，内核版本4.16，分别为i915和radeon驱动两张显卡。在启动
后，显示出display manager的登陆界面正确输入用户名和密码后需要几十妙时间
等待图形界面出现。"><meta property="og:locale" content="zh-cn"><meta property="article:published_time" content="2018-05-10T23:14:59"><meta property="article:modified_time" content="2018-05-10T23:14:59"><meta property="article:section" content="operating_system"><meta property="article:tag" content="desktop ui"><meta property="article:tag" content="linux"><meta name=twitter:card content="summary"><meta name=twitter:site content="@linuxhenhao"><meta name=twitter:creator content="@linuxhenhao"><meta property="og:image" content="https://blog.huangyu.me/images/header.png"><meta property="twitter:image" content="https://blog.huangyu.me/images/header.png"><title>笔记本图形界面启动慢问题探索与解决</title><link rel=icon href=/favicon.ico><link rel=canonical href=https://blog.huangyu.me/2018/05/%E7%AC%94%E8%AE%B0%E6%9C%AC%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E5%90%AF%E5%8A%A8%E6%85%A2%E9%97%AE%E9%A2%98%E6%8E%A2%E7%B4%A2%E4%B8%8E%E8%A7%A3%E5%86%B3/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin=anonymous><link rel=stylesheet href=/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/>多学多思考</a></div><a class=header-right-picture href=/#about><img class=header-picture src=https://blog.huangyu.me/images/header.png alt=作者的图片></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about><img class=sidebar-profile-picture src=https://blog.huangyu.me/images/header.png alt=作者的图片></a><h4 class=sidebar-profile-name>Yu Huang</h4><h5 class=sidebar-profile-bio>学而不思则罔，思而不学则殆</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/categories><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
<span class=sidebar-button-desc>分类</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags><i class="sidebar-button-icon fa fa-lg fa-tags"></i>
<span class=sidebar-button-desc>标签</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/archives><i class="sidebar-button-icon fa fa-lg fa-archive"></i>
<span class=sidebar-button-desc>归档</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about><i class="sidebar-button-icon fa fa-lg fa-question"></i>
<span class=sidebar-button-desc>关于</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/><i class="sidebar-button-icon fa fa-lg fa-home"></i>
<span class=sidebar-button-desc>首页</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/#mail><i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
<span class=sidebar-button-desc>diwang90#gmail</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/linuxhenhao target=_blank rel=noopener><i class="sidebar-button-icon fa fa-lg fa-github"></i>
<span class=sidebar-button-desc>GitHub</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml><i class="sidebar-button-icon fa fa-lg fa-rss"></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class="post-header main-content-wrap text-left"><h1 class=post-title itemprop=headline>笔记本图形界面启动慢问题探索与解决</h1><div class="postShorten-meta post-meta"><time itemprop=datePublished datetime=2018-05-10T23:14:59+08:00>五月 10, 2018</time>
<span>发布在</span>
<a class=category-link href=/categories/operating_system>operating_system</a></div></div><div class="post-content markdown" itemprop=articleBody><div class=main-content-wrap><p>问题描述：Y460 i3core m核显+ AMD HD5650，使用较老的硬件切换方式切换显卡。
新装Debian testing，内核版本4.16，分别为i915和radeon驱动两张显卡。在启动
后，显示出display manager的登陆界面正确输入用户名和密码后需要几十妙时间
等待图形界面出现。</p><h1 id=1-问题排查>1. 问题排查</h1><h2 id=11-启动过程分析>1.1 启动过程分析</h2><p>使用systemd-analyze plot 输出系统启动服务耗时情况，使用firefox打开输出的
svg文件观察</p><pre><code>systemd-analyze plot &gt; startup.svg
firefox startup.svg</code></pre><p>发现各个服务的启动时间都比较段，并行启动效果也很好，唯有一个docker.service
耗费了十几妙来启动。通过<code>systemctl disable docker.service</code>禁止其启动，对图形
界面出现慢的问题没有影响。后续分析原因，在于docker在后台启动服务其实与图形界面
的启动没有依赖关系，不会导致几十秒延迟这么严重的后果。</p><h2 id=12-查看log文件>1.2 查看log文件</h2><p>查看<code>.local/share/xorg/Xorg.0.log</code>发现 xserver 的启动就是在系统启动之后几十秒才
开始，说明问题不是来自于xserver启动及初始化等过程。</p><h2 id=13-display-manager的影响>1.3 display manager的影响</h2><p>怀疑和display manager有关，因为使用的是极简的 ly DM，安装slim，并设为默认DM，发现
问题仍然存在。停用DM，单纯使用startx启动图形界面，问题依旧, 该因素排除。</p><h2 id=14-查看dmesg>1.4 查看dmesg</h2><p>由于遇到过多次在进入系统后立即登入图形界面，或者立即运行startx启动图形界面后出现
xserver启动出错，提示no screen found的情况，怀疑问题来自于显卡驱动的初始化。</p><pre><code>dmesg | grep drm
dmesg | grep i915
dmesg | grep radeon</code></pre><p>通过上述命令观察驱动初始化情况，发现radeon的drm方面的初始化时间很晚，在开机几十秒后，
再和xserver启动的log对比，发现成功启动的xserver的log中，其启动时间刚好在drm初始化完成
后1秒左右。因此判断图形界面在登录后出现慢的根本原因在于驱动初始化上。</p><h1 id=2-尝试解决>2. 尝试解决</h1><h1 id=21-将radeon编译进内核>2.1 将radeon编译进内核</h1><p>这个过程比较简单，熟悉内核编译过程的话很快可以搞定，需要注意的是1. radeon编译进内核，
那么其需要的firmware也要编译进内核，否则无法加载，原因很直观（想象一下为什么）. 2.
firmware编译进内核需要制定firmware文件夹，以及firmware文件名，注意firmware文件夹真的
就是指到‘firmware’这一层次的文件夹，而firmware文件名应该形如radeon/xxxx.bin，具体某型号
显卡需要包含哪些firmware在gentoo的<a href=https://wiki.gentoo.org/wiki/Radeon#linux-firmware>wiki</a>上写得很明白了。</p><p>但是仍然存在同样的问题，说明这不是radeon模块加载的问题。</p><h1 id=22-问题最终解决>2.2 问题最终解决</h1><p>在<a href=https://www.phoronix.com/forums/forum/linux-graphics-x-org-drivers/open-source-amd-linux/872916-radeon-16s-boot-delay-with-black-screen-why-and-how-to-debug>phoronix论坛</a>上找到了类似的说法，结果是通过radeon.dpm=0，可以提高驱动初始化速度，
但是仍然很慢，需要十几秒时间。</p><p>最终找到一个freedesktop.org上的<a href="https://bugs.freedesktop.org/show_bug.cgi?id=105968">bug提交</a>，确定这是新版本内核代码更改导致的问题，根本原因
是radeon驱动的UVD clocking工作不正常导致的，开发
者表示已经知道这个问题了，但是我们没时间，这些老型号的显卡现在是不可能管的，以后会不会
管也不知道～。所以直接通过切换到4.9版本的内核避免了这个问题。。。</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small" href=/tags/desktop-ui/>desktop ui</a>
<a class="tag tag--primary tag--small" href=/tags/linux/>linux</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/05/xmind%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/ data-tooltip=XMind打包脚本><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">下一篇</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/04/%E5%9B%BE%E7%89%87%E7%9A%84%E5%A4%A7%E5%B0%8F%E4%B8%8E%E5%83%8F%E7%B4%A0%E8%B0%83%E8%8A%82tem%E5%9B%BE%E7%89%87%E8%87%B3%E7%BB%9F%E4%B8%80%E6%AF%94%E4%BE%8B%E5%B0%BA/ data-tooltip=图片的大小与像素——调节TEM图片至统一比例尺><span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-list"></i></a></li></ul></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2021 Yu Huang. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/05/xmind%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC/ data-tooltip=XMind打包脚本><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">下一篇</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/04/%E5%9B%BE%E7%89%87%E7%9A%84%E5%A4%A7%E5%B0%8F%E4%B8%8E%E5%83%8F%E7%B4%A0%E8%B0%83%E8%8A%82tem%E5%9B%BE%E7%89%87%E8%87%B3%E7%BB%9F%E4%B8%80%E6%AF%94%E4%BE%8B%E5%B0%BA/ data-tooltip=图片的大小与像素——调节TEM图片至统一比例尺><span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions><i class="fa fa-share-alt"></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#><i class="fa fa-list"></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-close"></i><ul class=share-options></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-remove"></i></div><img id=about-card-picture src=https://blog.huangyu.me/images/header.png alt=作者的图片><h4 id=about-card-name>Yu Huang</h4><div id=about-card-bio>学而不思则罔，思而不学则殆</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>想做程序猿</div><div id=about-card-location><i class="fa fa-map-marker"></i><br>Dream road</div></div></div><div id=cover style=background-image:url(https://blog.huangyu.me/images/cover.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin=anonymous></script><script src=/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js></script><script lang=javascript>window.onload=updateMinWidth,window.onresize=updateMinWidth,document.getElementById("sidebar").addEventListener("transitionend",updateMinWidth);function updateMinWidth(){var b=document.getElementById("sidebar"),a=document.getElementById("main"),c,d,e;a.style.minWidth="",c=getComputedStyle(a).getPropertyValue("min-width"),d=getComputedStyle(b).getPropertyValue("width"),e=getComputedStyle(b).getPropertyValue("left"),a.style.minWidth=`calc(${c} - ${d} - ${e})`}</script><script>$(document).ready(function(){hljs.configure({classPrefix:'',useBR:!1}),$('pre.code-highlight > code, pre > code').each(function(b,a){$(this).hasClass('codeblock')||$(this).addClass('codeblock'),hljs.highlightBlock(a)})})</script></body></html>